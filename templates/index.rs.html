@use super::base_html;
@use crate::statics::VersionInfo;

@(version_info: VersionInfo, repo_count: usize, base_url: &str)

@:base_html("Hits-of-Code Badges", "Hits-of-Code Badges", {

<p>
This API offers badges for the Hits-of-Code metric for your repositories. This metric was proposed by
<a href="https://www.yegor256.com/">Yegor Bugayenko</a> as an
<a href="https://www.yegor256.com/2014/11/14/hits-of-code.html">alternative to Lines-of-Code</a>.
</p>

<p>
Instead of counting the number of existing lines in a codebase, the number of modified lines is counted. That way, the
metric can only grow and never shrink. While this metric still cannot give any information about the code quality, it
gives an overview about the amount of work put into a codebase.
</p>

<p>
There is a <a href="https://github.com/yegor256/hoc/">command-line tool</a> to calculate the HoC of a repository. For a Git repository you can use this one-line command:
</p>

<p>
<code>
git log --pretty=tformat: --numstat --ignore-space-change --ignore-all-space --ignore-submodules --no-color --find-copies-harder -M --diff-filter=ACDM -- . | awk '$1 ~ /^[0-9]+$/ && $2 ~ /^[0-9]+$/ &#123 add += $1; del += $2 &#125 END &#123 print add + del &#125'
</code>
</p>

<p>
Some people might want a nice badge to put in their README, that's why I implemented this API. Currently the API can be
used for GitHub, GitLab, Bitbucket and Sourcehut repositories. Just put the following code in your README:
</p>

<p>
<code>
[![Hits-of-Code](@base_url/&lt;service&gt;/&lt;user&gt;/&lt;repo&gt;)](@base_url/&lt;service&gt;/&lt;user&gt;/&lt;repo&gt;/view)
</code>
</p>

<p>
where <code>&lt;service&gt;</code> is one of <code>github</code>, <code>gitlab</code>, <code>bitbucket</code> or
<code>sourcehut</code>. So the following Markdown
</p>

<p>
<code>
[![Hits-of-Code](@base_url/github/vbrandl/hoc)](@base_url/github/vbrandl/hoc/view)
</code>
</p>

<p>
would render this badge:
</p>

<p>
<a href="@base_url/github/vbrandl/hoc/view"><img src="@base_url/github/vbrandl/hoc"
alt="example badge" /></a>
</p>

<p>
    This service tries to detect the default branch of the repository and uses that branch as the target.
    Should the detection not work or you want the badge for another branch, just append
    <code>?branch=&lt;branch-name&gt;</code> to the URL.
</p>

<p>
    The badge label can be customized using the <code>label=&lt;some-label&gt;</code> query parameter. It defaults to
    <code>Hits-of-Code</code>.
</p>

<p>
    You can also request the HoC as JSON by appending <code>/json</code> to the request path. This will return a JSON
    object
    with three fields: <code>count</code> (the HoC value), <code>commits</code> (the number of commits) and
    <code>head</code> (the commit ref of HEAD). Requesting <a
        href="@base_url/github/vbrandl/hoc/json">@base_url/github/vbrandl/hoc/json</a> might return something along
    the lines of
</p>

<pre>
<code>
&#123;
    "head": "1f01c3b964b018fb0c0c2c5b572bf4ace2968546",
    "count": 8324,
    "commits": 223
&#125;
</code>
</pre>

<h2>Exclude Files</h2>

<p>
    The <code>exclude</code> query parameter can be used to exclude files from the calculated metric. It takes a URL
    encoded list of comma separated values similar to a <code>.gitignore</code> file.
    To exclude a specific file, you can pass <code>exclude=Cargo.lock</code>.
    You can also use globs to exclude all files matching a pattern: <code>exclude=*.generated.foo</code> (don't forget
    to URL encode the value).
</p>

<h2>Badge Generator</h2>

<form action="/generate">
    <fieldset>
        <label for="service">Service</label>
        <select name="service" id="service" required>
            <option value="github">GitHub</option>
            <option value="gitlab">Gitlab</option>
            <option value="bitbucket">Bitbucket</option>
            <option value="sourcehut">Sourcehut</option>
        </select>

        <label for="user">Owner</label>
        <input name="user" id="user" type="text" placeholder="Owner" required />

        <label for="repo">Repository</label>
        <input name="repo" id="repo" type="text" placeholder="Repository" required />

        <label for="branch">Branch</label>
        <input name="branch" id="branch" type="text" placeholder="Leave empty for default branch" />

        <label for="exclude">Excludes</label>
        <textarea name="exclude" id="exclude" placeholder="Exclude patterns as in .gitignore. One per line"></textarea>

        <label></label>
        <button type="submit">Generate</button>
    </fieldset>
</form>

<h2>Source Code</h2>

<p>
The whole service is licensed under the <a href="https://opensource.org/licenses/MIT">MIT license</a> and the source
code <a href="https://github.com/vbrandl/hoc">can be found on GitHub</a>. Feature proposals or pull requests are
welcome.
</p>

<h2>Contact</h2>

<p>
    You can reach me via mail: <a href="mailto:mail+hoc@@vbrandl.net">mail+hoc@@vbrandl.net</a> preferably using
my <a href="https://www.vbrandl.net/static/keys/0x1FFE431282F4B8CC0A7579167FB009175885FC76.asc">GPG key</a>
(<a href="http://pool.sks-keyservers.net/pks/lookup?op=get&amp;search=0x1FFE431282F4B8CC0A7579167FB009175885FC76">from a
    keyserver</a>), or by using any other UID from my key.
</p>
}, version_info, repo_count)
